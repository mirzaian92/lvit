---
type Item = { label: string; href: string };

type Props = {
  label: string;
  items: Item[];
  panelTitle?: string;
  maxHeightClass?: string;
};

const { label, items, panelTitle, maxHeightClass } = Astro.props as Props;
const idBase = label.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
const rootId = `navdd-${idBase}`;
const panelId = `${rootId}-panel`;
const closeDelayMs = 170;
---

<div class="navdd relative" data-navdd-root={rootId}>
  <button
    type="button"
    class="focus-ring inline-flex items-center gap-2 rounded-md px-2 py-1 text-sm font-medium text-brand-text hover:text-brand-primary"
    aria-haspopup="menu"
    aria-expanded="false"
    aria-controls={panelId}
    data-navdd-trigger
  >
    <span>{label}</span>
    <svg class="h-4 w-4 text-brand-text/70" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path
        fill-rule="evenodd"
        d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08z"
        clip-rule="evenodd"
      />
    </svg>
  </button>

  <div
    id={panelId}
    role="menu"
    aria-label={`${label} menu`}
    aria-hidden="true"
    data-open="false"
    class:list={[
      "absolute left-0 top-[calc(100%+10px)] z-50 w-[22rem] rounded-2xl border border-brand-border bg-white shadow-soft",
      "origin-top-left transition duration-150 ease-out",
      maxHeightClass || "max-h-[70vh]",
      "overflow-auto overscroll-contain",
    ]}
    data-navdd-panel
  >
    <div class="flex items-center justify-between gap-3 border-b border-brand-border px-5 py-4">
      <p class="text-sm font-semibold text-brand-primary">{panelTitle || label}</p>
      <p class="text-xs font-semibold text-brand-text/60">{items.length} items</p>
    </div>

    <ul class="p-2">
      {items.map((item) => (
        <li role="none">
          <a
            role="menuitem"
            href={item.href}
            tabindex="-1"
            class="focus-ring block rounded-xl px-4 py-3 text-sm font-medium text-brand-primary hover:bg-brand-primary hover:text-white"
          >
            {item.label}
          </a>
        </li>
      ))}
    </ul>
  </div>

  <style is:inline>
    [data-navdd-panel] {
      opacity: 0;
      transform: translateY(0.25rem);
      pointer-events: none;
      transition: opacity 150ms ease-out, transform 150ms ease-out;
    }
    .navdd:hover [data-navdd-panel],
    .navdd:focus-within [data-navdd-panel],
    [data-navdd-panel][data-open="true"] {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    @media (prefers-reduced-motion: reduce) {
      [data-navdd-panel] {
        transition: none;
      }
    }
  </style>

  <script type="module" is:inline>
    (() => {
      const rootId = {JSON.stringify(rootId)};
      const CLOSE_DELAY = {closeDelayMs};

      const root = document.querySelector(`[data-navdd-root="${rootId}"]`);
      if (!root) return;

      const trigger = root.querySelector("[data-navdd-trigger]");
      const panel = root.querySelector("[data-navdd-panel]");
      if (!trigger || !panel) return;

      const links = Array.from(panel.querySelectorAll("a"));
      const canHover = window.matchMedia?.("(hover: hover)").matches ?? true;
      let isOpen = false;
      let closeTimer = 0;

      function clearCloseTimer() {
        if (closeTimer) {
          window.clearTimeout(closeTimer);
          closeTimer = 0;
        }
      }

      function setFocusable(open) {
        for (const a of links) a.tabIndex = open ? 0 : -1;
      }

      function setOpen(next, opts = {}) {
        if (next === isOpen) return;
        isOpen = next;

        trigger.setAttribute("aria-expanded", String(isOpen));
        panel.setAttribute("aria-hidden", String(!isOpen));
        panel.dataset.open = isOpen ? "true" : "false";
        setFocusable(isOpen);

        if (isOpen) {
          window.dispatchEvent(new CustomEvent("navdd:open", { detail: { id: rootId } }));
        } else {
          if (opts.focusTrigger) trigger.focus();
        }
      }

      function scheduleClose() {
        clearCloseTimer();
        closeTimer = window.setTimeout(() => setOpen(false), CLOSE_DELAY);
      }

      function openNow() {
        clearCloseTimer();
        setOpen(true);
      }

      // Hover stability: root contains trigger + panel, so moving between them won't trigger leave.
      root.addEventListener("pointerenter", () => {
        if (!canHover) return;
        openNow();
      });
      root.addEventListener("pointerleave", () => {
        if (!canHover) return;
        if (root.matches?.(":focus-within")) return;
        scheduleClose();
      });

      // Focus stability: open on focus within, close when focus leaves container (with delay).
      root.addEventListener("focusin", () => openNow());
      root.addEventListener("focusout", (e) => {
        const next = e.relatedTarget;
        if (next && root.contains(next)) return;
        scheduleClose();
      });

      // Click-to-toggle: supports touchpads and mixed input.
      trigger.addEventListener("click", (e) => {
        e.preventDefault();
        clearCloseTimer();
        setOpen(!isOpen);
      });

      // Close on Escape.
      root.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        e.stopPropagation();
        clearCloseTimer();
        setOpen(false, { focusTrigger: true });
      });

      // Close after choosing an item.
      panel.addEventListener("click", (e) => {
        const link = e.target?.closest?.("a");
        if (!link) return;
        clearCloseTimer();
        setOpen(false);
      });

      // Close on outside click.
      document.addEventListener("pointerdown", (e) => {
        if (!isOpen) return;
        if (root.contains(e.target)) return;
        clearCloseTimer();
        setOpen(false);
      });

      // Ensure only one dropdown stays open at a time.
      window.addEventListener("navdd:open", (e) => {
        const opened = e.detail?.id;
        if (!opened || opened === rootId) return;
        clearCloseTimer();
        setOpen(false);
      });
    })();
  </script>
</div>
